
{% extends "principal/base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
  <div class="p-4 bg-white rounded shadow-sm mb-4">
    <h1 class="h3 mb-1">¡Bienvenido!</h1>
    <p>Pagina especializada en la busqueda del clima en los distintos lugares del mundo, que lo disfrute</p>
  </div>

  <div class="p-4 bg-white rounded shadow-sm">
    <h2 class="h5 mb-3">Clima</h2>

  <form method="get" class="row gy-2 gx-2 align-items-end">
    <div class="col-md-6 position-relative">
      <label class="form-label">{{ form_clima.ubicacion.label }}</label>
      {{ form_clima.ubicacion }}
      {{ form_clima.lat }}   
      {{ form_clima.lon }}   

    
      <div id="suggestions" class="list-group position-absolute w-100"
          style="z-index:1000; max-height:260px; overflow:auto; display:none;"></div>
    </div>

    <div class="col-md-3">
      <button type="submit" class="btn btn-primary w-100">Buscar</button>
    </div>
  </form>

    {% if clima_error %}
      <div class="alert alert-danger mt-3">{{ clima_error }}</div>
    {% endif %}

    {% if clima %}
      <hr>
      <h6 class="mb-2">Clima en {{ clima.lugar }}</h6>
      <p><strong>Ahora:</strong> {{ clima.temp_actual }}°C · {{ clima.cond_actual }}</p>

      <h6 class="mt-3">Próximos 7 días</h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr><th>Fecha</th><th>Condición</th><th>Máx (°C)</th><th>Mín (°C)</th></tr>
          </thead>
          <tbody>
            {% for d in clima.pronostico %}
              <tr>
                <td>{{ d.fecha }}</td>
                <td>{{ d.cond }}</td>
                <td>{{ d.tmax }}</td>
                <td>{{ d.tmin }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
  <script>
(function(){
  const input  = document.getElementById("id_ubicacion");
  const latFld = document.getElementById("id_lat");
  const lonFld = document.getElementById("id_lon");
  const box    = document.getElementById("suggestions");

  let t = null;
  const debounce = (fn, d)=> (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); };

  function clearS(){ box.innerHTML=""; box.style.display="none"; }
  function render(items){
    box.innerHTML="";
    items.forEach(it=>{
      const a=document.createElement("a");
      a.href="#";
      a.className="list-group-item list-group-item-action";
      const label=`${it.name}, ${it.country_code||""}${it.admin1? " · "+it.admin1 : ""}`;
      a.textContent=label;
      a.dataset.lat=it.latitude;
      a.dataset.lon=it.longitude;
      a.addEventListener("click", e=>{
        e.preventDefault();
        input.value=label;
        latFld.value=a.dataset.lat;
        lonFld.value=a.dataset.lon;
        clearS();
      });
      box.appendChild(a);
    });
    box.style.display = items.length ? "block" : "none";
  }

  async function fetchS(q){
    latFld.value=""; lonFld.value="";
    if(!q || q.length<2){ clearS(); return; }
    try{
      const url=new URL("https://geocoding-api.open-meteo.com/v1/search");
      url.searchParams.set("name", q);
      url.searchParams.set("count", "8");
      url.searchParams.set("language", "es");
      const res=await fetch(url);
      const data=await res.json();
      render(data.results || []);
    }catch(e){ clearS(); }
  }

  if(input){
    input.setAttribute("autocomplete", "off");
    input.addEventListener("input", debounce(e=>fetchS(e.target.value.trim()), 250));
    document.addEventListener("click", (e)=>{
      if(!box.contains(e.target) && e.target!==input) clearS();
    });
  }
})();
</script>
{% endblock %}