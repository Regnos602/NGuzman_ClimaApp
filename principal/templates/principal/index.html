{% extends "principal/base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}

<style>
  .hero-card {
    border-radius: 1rem;
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 45%, #4f46e5 100%);
    color: white;
    padding: 2.5rem 2rem;
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
    overflow: hidden;
    position: relative;
    margin-bottom: 1.5rem;
  }

  .hero-card::after {
    content: "";
    position: absolute;
    right: -80px;
    top: -80px;
    width: 220px;
    height: 220px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,255,255,.25), transparent 60%);
  }

  .hero-subtitle {
    opacity: .9;
  }

  .clima-card {
    border-radius: 1rem;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    border: none;
  }

  .table-clima th {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: #6b7280;
  }

  .badge-cond {
    font-size: .8rem;
    padding: .35rem .6rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
  }
</style>

<section class="mb-3">
  <div class="hero-card">
    <div class="row align-items-center">
      <div class="col-lg-7">
        <p class="mb-2 text-uppercase small hero-subtitle">
          Asistente meteorol√≥gico
        </p>
        <h1 class="display-6 fw-bold mb-2">
          ¬°Bienvenido/a ReClima!
        </h1>
        <p class="lead mb-0 hero-subtitle">
          P√°gina especializada en la b√∫squeda del clima en distintos lugares del mundo,
          para que puedas planear tus d√≠as con la mejor informaci√≥n.
        </p>
      </div>
      <div class="col-lg-5 text-lg-end mt-4 mt-lg-0">
        <div class="d-inline-flex align-items-center px-3 py-2 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25">
          <div class="me-2">
            <span class="fs-2">üå§Ô∏è</span>
          </div>
          <div class="small">
            <div class="fw-semibold">Clima actual y pr√≥ximos 7 d√≠as</div>
            <div class="opacity-75">Datos en tiempo real con Open-Meteo</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section>
  <div class="card clima-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Clima</h2>
        <span class="text-muted small">Escrib√≠ una ciudad y eleg√≠ una sugerencia</span>
      </div>


      <form method="get" class="row gy-2 gx-2 align-items-end">
        <div class="col-md-6 position-relative">
          <label class="form-label mb-1">{{ form_clima.ubicacion.label }}</label>
          {{ form_clima.ubicacion }}
          {{ form_clima.lat }}
          {{ form_clima.lon }}

          <div id="suggestions" class="list-group position-absolute w-100"
                style="z-index:1000; max-height:260px; overflow:auto; display:none;"></div>
        </div>

        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
      </form>

      {% if clima_error %}
        <div class="alert alert-danger mt-3 mb-0">
          {{ clima_error }}
        </div>
      {% endif %}

      {% if clima %}
        <hr class="my-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
          <div>
            <h6 class="mb-1">Clima en <span class="fw-semibold">{{ clima.lugar }}</span></h6>
            <p class="mb-0">
              <strong>Ahora:</strong> {{ clima.temp_actual }}¬∞C ¬∑
              <span class="badge-cond">{{ clima.cond_actual }}</span>
            </p>
          </div>
        </div>

        <h6 class="mt-2 mb-2">Pr√≥ximos 7 d√≠as</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle table-clima">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Condici√≥n</th>
                <th class="text-end">M√°x (¬∞C)</th>
                <th class="text-end">M√≠n (¬∞C)</th>
              </tr>
            </thead>
            <tbody>
              {% for d in clima.pronostico %}
                <tr>
                  <td>
                    {{ d.fecha }}
                    <span class="text-muted small">({{ d.dia }})</span>
                  </td>
                  <td>{{ d.cond }}</td>
                  <td class="text-end">{{ d.tmax }}</td>
                  <td class="text-end">{{ d.tmin }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
(function(){
  const input  = document.getElementById("id_ubicacion");
  const latFld = document.getElementById("id_lat");
  const lonFld = document.getElementById("id_lon");
  const box    = document.getElementById("suggestions");

  let t = null;
  const debounce = (fn, d)=> (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); };

  function clearS(){ box.innerHTML=""; box.style.display="none"; }
  function render(items){
    box.innerHTML="";
    items.forEach(it=>{
      const a=document.createElement("a");
      a.href="#";
      a.className="list-group-item list-group-item-action";
      const label=`${it.name}, ${it.country_code||""}${it.admin1? " ¬∑ "+it.admin1 : ""}`;
      a.textContent=label;
      a.dataset.lat=it.latitude;
      a.dataset.lon=it.longitude;
      a.addEventListener("click", e=>{
        e.preventDefault();
        input.value=label;
        latFld.value=a.dataset.lat;
        lonFld.value=a.dataset.lon;
        clearS();
      });
      box.appendChild(a);
    });
    box.style.display = items.length ? "block" : "none";
  }

  async function fetchS(q){
    latFld.value=""; lonFld.value="";
    if(!q || q.length<2){ clearS(); return; }
    try{
      const url=new URL("https://geocoding-api.open-meteo.com/v1/search");
      url.searchParams.set("name", q);
      url.searchParams.set("count", "8");
      url.searchParams.set("language", "es");
      const res=await fetch(url);
      const data=await res.json();
      render(data.results || []);
    }catch(e){ clearS(); }
  }

  if(input){
    input.setAttribute("autocomplete", "off");
    input.addEventListener("input", debounce(e=>fetchS(e.target.value.trim()), 250));
    document.addEventListener("click", (e)=>{
      if(!box.contains(e.target) && e.target!==input) clearS();
    });
  }
})();
</script>

{% endblock %}